<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Vibe Konek | Smart Anonymous Connection</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SOCKET.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        :root {
            --vibe-primary: #00D4FF;
            --vibe-secondary: #FF2E63;
            --vibe-accent: #9D4EDD;
            --vibe-dark: #0A0A0F;
        }
        
        /* Custom Styles */
        body {
            background-color: #0A0A0F;
            color: #FFFFFF;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Liquid Glass Effects */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .glass-intense {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(90deg, #00D4FF, #9D4EDD, #FF2E63);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #00D4FF, #9D4EDD);
            border-radius: 10px;
        }
        
        /* Chat Bubbles */
        .bubble-user {
            background: linear-gradient(135deg, #00D4FF, #0099FF);
            color: white;
            border-radius: 20px 20px 4px 20px;
            max-width: 80%;
        }
        
        .bubble-stranger {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 20px 20px 20px 4px;
            max-width: 80%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Loading Animation */
        .loading-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00D4FF;
            margin: 0 4px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Liquid Background */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
            pointer-events: none;
        }
        
        .liquid-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            animation: liquidFlow 20s ease-in-out infinite;
        }
        
        @keyframes liquidFlow {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        
        /* Button Effects */
        .btn-primary {
            background: linear-gradient(135deg, #00D4FF, #0099FF);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        /* Gender Colors */
        .gender-male { color: #00D4FF; }
        .gender-female { color: #FF2E63; }
        .gender-other { color: #9D4EDD; }
        
        /* File Upload */
        .file-preview {
            max-width: 200px;
            border-radius: 12px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .file-preview img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .glass-card {
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                border-radius: 20px;
            }
            
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-full {
                width: 100vw;
                position: relative;
                left: 50%;
                right: 50%;
                margin-left: -50vw;
                margin-right: -50vw;
            }
            
            /* Mobile chat layout */
            .mobile-chat-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 100;
                background: #0A0A0F;
            }
            
            .mobile-chat-header {
                background: rgba(10, 10, 15, 0.95);
                backdrop-filter: blur(20px);
                padding: 1rem;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .mobile-chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                padding-bottom: 120px; /* Space for input */
            }
            
            .mobile-chat-input {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(10, 10, 15, 0.95);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                padding: 1rem;
            }
        }
        
        /* Desktop Optimizations */
        @media (min-width: 769px) {
            .desktop-hidden {
                display: none !important;
            }
        }
        
        /* Animation Classes */
        .animate-slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }
        
        .animate-slide-down {
            animation: slideDown 0.4s ease-out forwards;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes slideUp {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideDown {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        /* File Sharing Modal */
        .file-dropzone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-dropzone:hover {
            border-color: #00D4FF;
            background: rgba(0, 212, 255, 0.05);
        }
        
        .file-dropzone.drag-over {
            border-color: #9D4EDD;
            background: rgba(157, 78, 221, 0.1);
        }
    </style>
</head>

<body class="antialiased">
    <!-- Liquid Background -->
    <div class="liquid-bg">
        <div class="liquid-blob w-[500px] h-[500px] bg-[#00D4FF] top-[-100px] left-[-100px] opacity-30"></div>
        <div class="liquid-blob w-[400px] h-[400px] bg-[#FF2E63] top-[40%] right-[-50px] opacity-25" style="animation-delay: -5s;"></div>
        <div class="liquid-blob w-[600px] h-[600px] bg-[#9D4EDD] bottom-[-150px] left-[30%] opacity-20" style="animation-delay: -10s;"></div>
    </div>
    
    <!-- Server Connection Modal -->
    <div id="server-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 animate-fade-in">
        <div class="glass-card max-w-md w-full p-8">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#00D4FF] to-[#9D4EDD] flex items-center justify-center">
                    <i class="fa-solid fa-plug text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white">Welcome to Vibe Konek</h2>
                    <p class="text-sm text-gray-400">Connecting to chat server...</p>
                </div>
            </div>
            
            <div class="text-center space-y-4">
                <div class="loading-dots mb-4">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <p class="text-gray-300" id="server-status">Initializing connection...</p>
                <div class="pt-4">
                    <button onclick="retryConnection()" class="text-sm text-gray-400 hover:text-white">
                        Retry connection
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-40 p-4 bg-black/50 backdrop-blur-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="glass-card w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-bolt text-[#00D4FF] text-lg md:text-xl"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-bold">
                    Vibe<span class="gradient-text">Konek</span>
                </h1>
            </div>
            
            <div class="hidden md:flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-2 glass-card rounded-full">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-sm font-medium" id="online-count">0</span>
                    <span class="text-xs text-gray-400">online</span>
                </div>
                
                <button onclick="openSettings()" class="glass-card w-10 h-10 rounded-xl flex items-center justify-center hover:scale-105 transition-transform">
                    <i class="fa-solid fa-sliders-h"></i>
                </button>
            </div>
            
            <button class="md:hidden glass-card w-10 h-10 rounded-xl flex items-center justify-center" onclick="toggleMobileMenu()">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="md:hidden glass-card mt-3 p-4 rounded-2xl hidden animate-slide-down">
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-sm font-medium" id="mobile-online-count">0</span>
                        <span class="text-xs text-gray-400">online</span>
                    </div>
                    
                    <button onclick="openSettings()" class="glass-card w-8 h-8 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-sliders-h text-sm"></i>
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="startChat('text')" class="flex-1 btn-primary py-2.5 rounded-xl text-sm font-bold">
                        <i class="fa-solid fa-comment mr-1"></i> Text Chat
                    </button>
                    <button onclick="startChat('video')" class="flex-1 btn-secondary py-2.5 rounded-xl text-sm font-bold">
                        <i class="fa-solid fa-video mr-1"></i> Video
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="pt-24 pb-20 px-4 max-w-7xl mx-auto">
        <!-- Hero Section -->
        <section id="home-section" class="text-center mb-16 md:mb-20">
            <div class="inline-flex items-center gap-2 px-4 py-2 glass-card rounded-full mb-6 animate-float">
                <i class="fa-solid fa-bolt text-[#00D4FF]"></i>
                <span class="text-xs md:text-sm font-bold">ANONYMOUS • SMART MATCHING • FILE SHARE</span>
            </div>
            
            <h1 class="text-4xl md:text-7xl font-bold mb-6">
                Connect <span class="gradient-text">Instantly</span><br class="hidden md:block"/>
                <span class="text-3xl md:text-7xl">With <span class="gradient-text">Strangers</span></span>
            </h1>
            
            <p class="text-lg md:text-xl text-gray-300 max-w-2xl mx-auto mb-10">
                Smart anonymous chat with gender-aware matching, file sharing, and real-time connections.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center mb-12 md:mb-16">
                <button onclick="openSettings()" class="btn-primary px-6 md:px-8 py-3 md:py-4 rounded-2xl text-base md:text-lg font-bold flex items-center justify-center gap-2 md:gap-3">
                    <i class="fa-solid fa-play"></i> Start Smart Chat
                </button>
                <button onclick="openServerInfo()" class="btn-secondary px-6 md:px-8 py-3 md:py-4 rounded-2xl text-base md:text-lg font-bold">
                    <i class="fa-solid fa-server mr-2"></i> Server Info
                </button>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 max-w-3xl mx-auto">
                <div class="glass-card p-4 md:p-6 rounded-2xl">
                    <div class="text-2xl md:text-3xl font-bold gradient-text">Smart</div>
                    <div class="text-xs md:text-sm text-gray-400 mt-1 md:mt-2">Gender Matching</div>
                </div>
                <div class="glass-card p-4 md:p-6 rounded-2xl">
                    <div class="text-2xl md:text-3xl font-bold gradient-text">E2EE</div>
                    <div class="text-xs md:text-sm text-gray-400 mt-1 md:mt-2">Encrypted</div>
                </div>
                <div class="glass-card p-4 md:p-6 rounded-2xl">
                    <div class="text-2xl md:text-3xl font-bold gradient-text">150+</div>
                    <div class="text-xs md:text-sm text-gray-400 mt-1 md:mt-2">Countries</div>
                </div>
                <div class="glass-card p-4 md:p-6 rounded-2xl">
                    <div class="text-2xl md:text-3xl font-bold gradient-text">File</div>
                    <div class="text-xs md:text-sm text-gray-400 mt-1 md:mt-2">Sharing</div>
                </div>
            </div>
        </section>
        
        <!-- Desktop Chat Interface -->
        <section id="desktop-chat-section" class="hidden desktop-hidden">
            <div class="grid lg:grid-cols-3 gap-4 md:gap-6 h-[calc(100vh-180px)]">
                <!-- Chat Area -->
                <div class="lg:col-span-2">
                    <div class="glass-card h-full flex flex-col">
                        <!-- Chat Header -->
                        <div class="p-4 md:p-6 border-b border-[rgba(255,255,255,0.12)] flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div id="partner-avatar" class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-[#00D4FF] to-[#9D4EDD] flex items-center justify-center">
                                    <i class="fa-solid fa-user-secret text-xs md:text-sm"></i>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-bold text-sm md:text-base" id="partner-name">Anonymous</h3>
                                        <span id="partner-gender" class="text-xs px-2 py-1 rounded-full bg-white/10"></span>
                                    </div>
                                    <p class="text-xs text-gray-400" id="chat-status">Connecting...</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="toggleFileUpload()" class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors" title="Send File">
                                    <i class="fa-solid fa-paperclip text-xs md:text-sm"></i>
                                </button>
                                <button onclick="skipPartner()" class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors" title="Next Partner">
                                    <i class="fa-solid fa-forward text-xs md:text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Messages -->
                        <div id="messages-container" class="flex-1 p-4 md:p-6 overflow-y-auto">
                            <div class="space-y-3 md:space-y-4" id="messages">
                                <!-- Messages will appear here -->
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div class="p-4 md:p-6 border-t border-[rgba(255,255,255,0.12)]">
                            <div class="flex gap-3">
                                <div class="flex-1 flex gap-2">
                                    <button onclick="toggleFileUpload()" class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                    <textarea id="message-input" rows="1" placeholder="Type your message..." class="flex-1 bg-black/30 border border-[rgba(255,255,255,0.12)] rounded-xl px-4 py-3 text-sm focus:border-[#00D4FF] focus:outline-none resize-none" disabled></textarea>
                                </div>
                                <button onclick="sendMessage()" id="send-btn" class="btn-primary w-10 h-10 md:w-14 md:h-14 rounded-xl flex items-center justify-center" disabled>
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="flex justify-between mt-3">
                                <div class="text-xs text-gray-500">
                                    Press <kbd class="px-2 py-1 bg-black/30 rounded">Enter</kbd> to send
                                </div>
                                <button onclick="endChat()" class="text-sm text-red-400 hover:text-red-300">
                                    <i class="fa-solid fa-power-off mr-1"></i> End
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Side Panel -->
                <div class="lg:col-span-1">
                    <div class="glass-card h-full p-4 md:p-6 flex flex-col">
                        <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6">Your Vibe</h3>
                        
                        <!-- Profile -->
                        <div class="mb-6 md:mb-8">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 md:w-16 md:h-16 rounded-2xl bg-gradient-to-br from-[#00D4FF] to-[#9D4EDD] flex items-center justify-center text-lg md:text-2xl">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-sm md:text-base" id="user-name">Anonymous</h4>
                                    <div class="flex items-center gap-1">
                                        <span class="text-xs text-gray-400">Gender:</span>
                                        <span class="text-xs md:text-sm font-medium" id="user-gender-display">Not set</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-gray-500 block mb-1">Interests</label>
                                    <div class="flex flex-wrap gap-1 md:gap-2" id="interests-tags">
                                        <span class="px-2 py-0.5 md:px-3 md:py-1 bg-white/5 rounded-full text-xs">#chat</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 block mb-1">Looking for</label>
                                    <div class="flex flex-wrap gap-1 md:gap-2" id="gender-pref-tags">
                                        <span class="px-2 py-0.5 md:px-3 md:py-1 bg-white/5 rounded-full text-xs">Anyone</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Matching Status -->
                        <div class="space-y-3 md:space-y-4 mb-6 md:mb-8">
                            <h4 class="font-bold">Matching Status</h4>
                            <div class="space-y-2 md:space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-400 text-sm">Algorithm:</span>
                                    <span class="font-bold text-green-400 text-sm" id="matching-algo">Smart</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400 text-sm">Queue:</span>
                                    <span class="font-bold text-sm" id="queue-position">1</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400 text-sm">Match %:</span>
                                    <span class="font-bold text-sm" id="compatibility-score">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="space-y-3 md:space-y-4 mb-6 md:mb-8">
                            <h4 class="font-bold">Quick Actions</h4>
                            <button onclick="changeGenderPref()" class="w-full btn-secondary py-2.5 md:py-3 rounded-xl flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-venus-mars"></i> Gender Filter
                            </button>
                            <button onclick="openServerInfo()" class="w-full btn-secondary py-2.5 md:py-3 rounded-xl flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-server"></i> Server Info
                            </button>
                        </div>
                        
                        <!-- Stats -->
                        <div class="mt-auto">
                            <h4 class="font-bold mb-3 md:mb-4">Session Stats</h4>
                            <div class="space-y-2 md:space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-400 text-sm">Time</span>
                                    <span class="font-bold text-sm" id="session-time">0:00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400 text-sm">Messages</span>
                                    <span class="font-bold text-sm" id="message-count">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400 text-sm">Partners</span>
                                    <span class="font-bold text-sm" id="partner-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Mobile Chat Interface -->
        <section id="mobile-chat-section" class="hidden mobile-chat-container">
            <!-- Mobile Chat Header -->
            <div class="mobile-chat-header">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="closeMobileChat()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <div class="flex items-center gap-2">
                            <div id="mobile-partner-avatar" class="w-8 h-8 rounded-full bg-gradient-to-br from-[#00D4FF] to-[#9D4EDD] flex items-center justify-center">
                                <i class="fa-solid fa-user-secret text-xs"></i>
                            </div>
                            <div>
                                <div class="flex items-center gap-1">
                                    <h3 class="font-bold text-sm" id="mobile-partner-name">Anonymous</h3>
                                    <span id="mobile-partner-gender" class="text-xs px-1.5 py-0.5 rounded-full bg-white/10"></span>
                                </div>
                                <p class="text-xs text-gray-400" id="mobile-chat-status">Connecting...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-1">
                        <button onclick="toggleMobileFileUpload()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fa-solid fa-paperclip text-xs"></i>
                        </button>
                        <button onclick="skipPartner()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fa-solid fa-forward text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Messages -->
            <div class="mobile-chat-messages" id="mobile-messages-container">
                <div class="space-y-3" id="mobile-messages">
                    <!-- Messages will appear here -->
                </div>
            </div>
            
            <!-- Mobile Input Area -->
            <div class="mobile-chat-input">
                <div class="flex gap-2">
                    <button onclick="toggleMobileFileUpload()" class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <textarea id="mobile-message-input" rows="1" placeholder="Type message..." class="flex-1 bg-black/30 border border-[rgba(255,255,255,0.12)] rounded-xl px-3 py-2.5 text-sm focus:border-[#00D4FF] focus:outline-none resize-none" disabled></textarea>
                    <button onclick="sendMobileMessage()" id="mobile-send-btn" class="btn-primary w-10 h-10 rounded-xl flex items-center justify-center" disabled>
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hidden">
        <div class="glass-card max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4 md:p-6 border-b border-[rgba(255,255,255,0.12)] flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold">Smart Matching Settings</h2>
                <button onclick="closeSettings()" class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 md:p-6 space-y-4 md:space-y-6">
                <!-- Profile -->
                <div>
                    <h3 class="text-base md:text-lg font-bold mb-3 md:mb-4">Your Profile</h3>
                    <div class="space-y-3 md:space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 block mb-2">Display Name</label>
                            <input type="text" id="display-name" placeholder="Anonymous" class="w-full bg-black/30 border border-[rgba(255,255,255,0.12)] rounded-xl px-3 md:px-4 py-2.5 md:py-3 focus:border-[#00D4FF] focus:outline-none text-sm md:text-base" />
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-400 block mb-2">Your Gender</label>
                            <select id="gender-select" class="w-full bg-black/30 border border-[rgba(255,255,255,0.12)] rounded-xl px-3 md:px-4 py-2.5 md:py-3 focus:border-[#00D4FF] focus:outline-none text-sm md:text-base">
                                <option value="prefer-not-to-say">Prefer not to say</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-400 block mb-2">Connect with</label>
                            <select id="gender-pref" class="w-full bg-black/30 border border-[rgba(255,255,255,0.12)] rounded-xl px-3 md:px-4 py-2.5 md:py-3 focus:border-[#00D4FF] focus:outline-none text-sm md:text-base">
                                <option value="any">Anyone</option>
                                <option value="male">Males only</option>
                                <option value="female">Females only</option>
                                <option value="same">Same gender</option>
                                <option value="opposite">Opposite gender</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-400 block mb-2">Interests (comma separated)</label>
                            <input type="text" id="interests-input" placeholder="music, gaming, tech, movies, sports" class="w-full bg-black/30 border border-[rgba(255,255,255,0.12)] rounded-xl px-3 md:px-4 py-2.5 md:py-3 focus:border-[#00D4FF] focus:outline-none text-sm md:text-base" />
                        </div>
                    </div>
                </div>
                
                <!-- Matching Preferences -->
                <div>
                    <h3 class="text-base md:text-lg font-bold mb-3 md:mb-4">Matching Preferences</h3>
                    <div class="grid grid-cols-2 gap-3 md:gap-4">
                        <button onclick="selectMatchSpeed('fast')" id="speed-fast" class="p-3 md:p-4 rounded-xl border border-[#00D4FF] bg-[#00D4FF]/10 flex flex-col items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-lg md:text-xl text-[#00D4FF]"></i>
                            <span class="font-bold text-xs md:text-sm">Fast</span>
                            <span class="text-xs text-gray-400">Quick match</span>
                        </button>
                        
                        <button onclick="selectMatchSpeed('balanced')" id="speed-balanced" class="p-3 md:p-4 rounded-xl border border-[rgba(255,255,255,0.12)] bg-white/5 flex flex-col items-center justify-center gap-2 hover:border-[#00D4FF] transition-colors">
                            <i class="fa-solid fa-scale-balanced text-lg md:text-xl text-gray-400"></i>
                            <span class="font-bold text-xs md:text-sm">Balanced</span>
                            <span class="text-xs text-gray-400">Better match</span>
                        </button>
                    </div>
                </div>
                
                <!-- Start Button -->
                <button onclick="startSmartMatching()" class="w-full btn-primary py-3 md:py-4 rounded-xl text-base md:text-lg font-bold flex items-center justify-center gap-2 md:gap-3">
                    <i class="fa-solid fa-play"></i> Start Smart Matching
                </button>
            </div>
        </div>
    </div>
    
    <!-- File Upload Modal -->
    <div id="file-modal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hidden">
        <div class="glass-card max-w-md w-full">
            <div class="p-4 md:p-6 border-b border-[rgba(255,255,255,0.12)] flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold">Send File</h2>
                <button onclick="closeFileModal()" class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 md:p-6">
                <div id="file-dropzone" class="file-dropzone">
                    <i class="fa-solid fa-cloud-upload-alt text-3xl md:text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-300 font-bold mb-1">Drop file here or click to upload</p>
                    <p class="text-xs text-gray-500">Max file size: 5MB • Images, PDF, Text</p>
                    <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.txt,.doc,.docx" />
                </div>
                
                <div id="file-preview" class="hidden mt-4">
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-file text-lg text-[#00D4FF]"></i>
                            <div>
                                <p class="font-bold text-sm" id="file-name"></p>
                                <p class="text-xs text-gray-400" id="file-size"></p>
                            </div>
                        </div>
                        <button onclick="removeFile()" class="text-red-400 hover:text-red-300">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="closeFileModal()" class="flex-1 btn-secondary py-3 rounded-xl font-bold">
                        Cancel
                    </button>
                    <button onclick="sendFile()" id="send-file-btn" class="flex-1 btn-primary py-3 rounded-xl font-bold" disabled>
                        <i class="fa-solid fa-paper-plane mr-2"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Server Info Modal -->
    <div id="server-info-modal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hidden">
        <div class="glass-card max-w-md w-full">
            <div class="p-4 md:p-6 border-b border-[rgba(255,255,255,0.12)] flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold">Server Information</h2>
                <button onclick="closeServerInfo()" class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/10 flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 md:p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">Status:</span>
                    <span class="font-bold text-green-400" id="server-connection-status">Connected</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">Server:</span>
                    <span class="font-bold" id="current-server">vibekonek-server.onrender.com</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">Online Users:</span>
                    <span class="font-bold" id="server-online-count">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">Ping:</span>
                    <span class="font-bold" id="server-ping">0ms</span>
                </div>
                
                <div class="pt-4 border-t border-[rgba(255,255,255,0.12)]">
                    <h4 class="font-bold mb-2">Server Actions</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="reconnectServer()" class="btn-secondary py-2.5 rounded-xl text-sm">
                            <i class="fa-solid fa-rotate mr-1"></i> Reconnect
                        </button>
                        <button onclick="disconnectServer()" class="btn-secondary py-2.5 rounded-xl text-sm">
                            <i class="fa-solid fa-plug mr-1"></i> Disconnect
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="py-6 md:py-8 px-4 border-t border-[rgba(255,255,255,0.12)] bg-black/30">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 md:gap-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl glass-card flex items-center justify-center">
                        <i class="fa-solid fa-bolt text-[#00D4FF]"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm md:text-base">Vibe Konek</h3>
                        <p class="text-xs text-gray-500">Smart Anonymous Connections</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-4 md:gap-6 text-xs md:text-sm">
                    <button onclick="openSafety()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-shield mr-1"></i> Safety
                    </button>
                    <button onclick="openServerInfo()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-server mr-1"></i> Server
                    </button>
                    <button onclick="openSettings()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-sliders-h mr-1"></i> Settings
                    </button>
                </div>
                
                <div class="text-xs text-gray-500">
                    © 2025 Vibe Konek. Smart matching system.
                </div>
            </div>
        </div>
    </footer>

    <script>
        // --- SOCKET.IO CONNECTION ---
        let socket = null;
        const SERVER_URL = "https://vibekonek-server.onrender.com";
        let isConnected = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        // --- GLOBAL STATE ---
        let appState = {
            userId: generateId(),
            userName: 'Anonymous',
            userGender: 'prefer-not-to-say',
            genderPreference: 'any',
            interests: ['chat'],
            partner: null,
            isChatting: false,
            isSearching: false,
            currentMode: 'text',
            sessionStart: null,
            messageCount: 0,
            partnerCount: 0,
            compatibilityScore: 0,
            queuePosition: 1,
            matchSpeed: 'balanced',
            fileToSend: null
        };
        
        // --- DOM ELEMENTS ---
        const serverModal = document.getElementById('server-modal');
        const settingsModal = document.getElementById('settings-modal');
        const fileModal = document.getElementById('file-modal');
        const serverInfoModal = document.getElementById('server-info-modal');
        const homeSection = document.getElementById('home-section');
        const desktopChatSection = document.getElementById('desktop-chat-section');
        const mobileChatSection = document.getElementById('mobile-chat-section');
        
        // --- UTILITY FUNCTIONS ---
        function generateId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function updateGenderDisplay(gender) {
            const display = document.getElementById('user-gender-display');
            const genderMap = {
                'male': 'Male',
                'female': 'Female', 
                'other': 'Other',
                'prefer-not-to-say': 'Not specified'
            };
            display.textContent = genderMap[gender] || 'Not set';
        }
        
        function updateGenderPreferenceDisplay(pref) {
            const container = document.getElementById('gender-pref-tags');
            container.innerHTML = '';
            
            const prefMap = {
                'any': 'Anyone',
                'male': 'Males only',
                'female': 'Females only',
                'same': 'Same gender',
                'opposite': 'Opposite gender'
            };
            
            const tag = document.createElement('span');
            tag.className = 'px-2 py-0.5 md:px-3 md:py-1 bg-white/5 rounded-full text-xs';
            tag.textContent = prefMap[pref] || 'Anyone';
            container.appendChild(tag);
        }
        
        function getGenderColor(gender) {
            const colors = {
                'male': 'gender-male',
                'female': 'gender-female',
                'other': 'gender-other'
            };
            return colors[gender] || 'text-gray-400';
        }
        
        function getGenderIcon(gender) {
            const icons = {
                'male': 'fa-mars',
                'female': 'fa-venus',
                'other': 'fa-transgender'
            };
            return icons[gender] || 'fa-user';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // --- SOCKET.IO FUNCTIONS ---
        function connectSocket() {
            socket = io(SERVER_URL, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
                reconnectionDelay: 1000,
                timeout: 10000
            });
            
            socket.on('connect', () => {
                console.log('Connected to server');
                isConnected = true;
                reconnectAttempts = 0;
                
                updateServerStatus('Connected', 'green-400');
                document.getElementById('server-status').textContent = 'Connected successfully!';
                
                // Hide server modal after 1 second
                setTimeout(() => {
                    serverModal.classList.add('hidden');
                }, 1000);
                
                // Update server info
                updateServerInfo();
                
                // Start ping interval
                startPing();
                
                // Register user
                socket.emit('register', {
                    userId: appState.userId,
                    name: appState.userName,
                    gender: appState.userGender,
                    genderPreference: appState.genderPreference,
                    interests: appState.interests
                });
            });
            
            socket.on('onlineCount', (count) => {
                updateOnlineCount(count);
            });
            
            socket.on('matchFound', (partner) => {
                handleMatchFound(partner);
            });
            
            socket.on('message', (data) => {
                handleIncomingMessage(data);
            });
            
            socket.on('file', (data) => {
                handleIncomingFile(data);
            });
            
            socket.on('partnerDisconnected', () => {
                handlePartnerDisconnect();
            });
            
            socket.on('queueUpdate', (position) => {
                updateQueuePosition(position);
            });
            
            socket.on('disconnect', (reason) => {
                handleDisconnect(reason);
            });
            
            socket.on('connect_error', (error) => {
                handleConnectionError(error);
            });
        }
        
        function updateServerStatus(status, color) {
            const statusEl = document.getElementById('server-connection-status');
            statusEl.textContent = status;
            statusEl.className = `font-bold text-${color}`;
        }
        
        function updateServerInfo() {
            if (socket && socket.connected) {
                document.getElementById('current-server').textContent = SERVER_URL.replace('https://', '');
            }
        }
        
        function startPing() {
            setInterval(() => {
                if (socket && socket.connected) {
                    const start = Date.now();
                    socket.emit('ping');
                    socket.once('pong', () => {
                        const ping = Date.now() - start;
                        document.getElementById('server-ping').textContent = `${ping}ms`;
                    });
                }
            }, 5000);
        }
        
        function updateOnlineCount(count) {
            document.getElementById('online-count').textContent = count;
            document.getElementById('mobile-online-count').textContent = count;
            document.getElementById('server-online-count').textContent = count;
        }
        
        function updateQueuePosition(position) {
            appState.queuePosition = position;
            document.getElementById('queue-position').textContent = position;
            
            if (position > 1) {
                document.getElementById('chat-status').textContent = `In queue: #${position}`;
                document.getElementById('mobile-chat-status').textContent = `In queue: #${position}`;
            }
        }
        
        // --- MATCHING FUNCTIONS ---
        function handleMatchFound(partner) {
            appState.partner = partner;
            appState.isChatting = true;
            appState.isSearching = false;
            appState.partnerCount++;
            
            // Calculate compatibility
            const compatibility = calculateCompatibility(partner);
            appState.compatibilityScore = compatibility;
            
            // Update UI
            updatePartnerUI(partner, compatibility);
            
            // Enable chat input
            enableChatInput();
            
            // Add welcome messages
            addMessage('system', `Matched with ${partner.name || 'Anonymous'}!`);
            addMessage('system', `Gender: ${partner.gender || 'Not specified'} • Match: ${compatibility}%`);
            
            // Update stats
            updateStats();
        }
        
        function calculateCompatibility(partner) {
            let score = 50; // Base score
            
            // Gender preference match
            if (appState.genderPreference !== 'any') {
                if (appState.genderPreference === 'same' && appState.userGender === partner.gender) {
                    score += 20;
                } else if (appState.genderPreference === 'opposite' && appState.userGender !== partner.gender) {
                    score += 20;
                } else if (appState.genderPreference === partner.gender) {
                    score += 20;
                }
            }
            
            // Interest matching
            const commonInterests = getCommonInterests(partner.interests).length;
            score += Math.min(commonInterests * 10, 30);
            
            return Math.min(Math.round(score), 100);
        }
        
        function getCommonInterests(partnerInterests) {
            if (!partnerInterests) return [];
            return appState.interests.filter(interest => 
                partnerInterests.some(pi => 
                    pi.toLowerCase().includes(interest.toLowerCase()) || 
                    interest.toLowerCase().includes(pi.toLowerCase())
                )
            );
        }
        
        function updatePartnerUI(partner, compatibility) {
            // Update desktop UI
            document.getElementById('partner-name').textContent = partner.name || 'Anonymous';
            document.getElementById('mobile-partner-name').textContent = partner.name || 'Anonymous';
            
            const genderSpan = document.getElementById('partner-gender');
            const mobileGenderSpan = document.getElementById('mobile-partner-gender');
            
            const genderText = partner.gender === 'male' ? 'Male' : 
                              partner.gender === 'female' ? 'Female' : 
                              partner.gender === 'other' ? 'Other' : 'Unknown';
            
            genderSpan.textContent = genderText;
            mobileGenderSpan.textContent = genderText;
            
            genderSpan.className = `text-xs px-2 py-1 rounded-full ${getGenderColor(partner.gender)} bg-white/10`;
            mobileGenderSpan.className = `text-xs px-1.5 py-0.5 rounded-full ${getGenderColor(partner.gender)} bg-white/10`;
            
            // Update avatars
            document.getElementById('partner-avatar').innerHTML = `<i class="fa-solid ${getGenderIcon(partner.gender)}"></i>`;
            document.getElementById('mobile-partner-avatar').innerHTML = `<i class="fa-solid ${getGenderIcon(partner.gender)}"></i>`;
            
            // Update status
            document.getElementById('chat-status').textContent = 'Connected';
            document.getElementById('mobile-chat-status').textContent = 'Connected';
            
            // Update compatibility
            document.getElementById('compatibility-score').textContent = `${compatibility}%`;
        }
        
        // --- CHAT FUNCTIONS ---
        function enableChatInput() {
            const messageInput = document.getElementById('message-input');
            const mobileMessageInput = document.getElementById('mobile-message-input');
            const sendBtn = document.getElementById('send-btn');
            const mobileSendBtn = document.getElementById('mobile-send-btn');
            
            if (messageInput) messageInput.disabled = false;
            if (mobileMessageInput) mobileMessageInput.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
            if (mobileSendBtn) mobileSendBtn.disabled = false;
            
            // Focus on input
            if (window.innerWidth >= 768) {
                messageInput?.focus();
            } else {
                mobileMessageInput?.focus();
            }
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const mobileMessageInput = document.getElementById('mobile-message-input');
            
            const text = window.innerWidth >= 768 ? 
                messageInput.value.trim() : 
                mobileMessageInput.value.trim();
            
            if (!text || !appState.isChatting) return;
            
            // Add message to UI
            addMessage('user', text);
            
            // Clear input
            if (messageInput) messageInput.value = '';
            if (mobileMessageInput) mobileMessageInput.value = '';
            
            // Send via socket
            if (socket && socket.connected && appState.partner) {
                socket.emit('message', {
                    to: appState.partner.userId,
                    text: text,
                    sender: appState.userId,
                    type: 'text'
                });
                
                appState.messageCount++;
                updateStats();
            }
        }
        
        function sendMobileMessage() {
            sendMessage();
        }
        
        function handleIncomingMessage(data) {
            if (data.sender === appState.partner?.userId) {
                addMessage('stranger', data.text);
                appState.messageCount++;
                updateStats();
            }
        }
        
        function addMessage(sender, text, isFile = false, fileData = null) {
            const isMobile = window.innerWidth < 768;
            const containerId = isMobile ? 'mobile-messages' : 'messages';
            const container = document.getElementById(containerId);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'flex justify-end mb-3' : 'flex justify-start mb-3';
            
            if (sender === 'system') {
                messageDiv.className = 'flex justify-center mb-3';
                const systemMsg = document.createElement('div');
                systemMsg.className = 'px-3 py-1.5 bg-white/5 rounded-full text-xs text-gray-400';
                systemMsg.textContent = text;
                messageDiv.appendChild(systemMsg);
            } else {
                const bubble = document.createElement('div');
                bubble.className = sender === 'user' ? 'bubble-user' : 'bubble-stranger';
                bubble.style.maxWidth = '85%';
                
                if (isFile && fileData) {
                    // File message
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'p-3';
                    
                    if (fileData.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = fileData.data;
                        img.className = 'rounded-lg max-w-full h-auto';
                        img.alt = 'Shared image';
                        fileDiv.appendChild(img);
                        
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'mt-2 text-xs text-[#00D4FF] hover:underline flex items-center gap-1';
                        downloadBtn.innerHTML = `<i class="fa-solid fa-download"></i> Download`;
                        downloadBtn.onclick = () => downloadFile(fileData.data, fileData.name);
                        fileDiv.appendChild(downloadBtn);
                    } else {
                        const fileInfo = document.createElement('div');
                        fileInfo.className = 'flex items-center gap-3 p-3 bg-white/5 rounded-lg';
                        fileInfo.innerHTML = `
                            <i class="fa-solid fa-file text-lg text-[#00D4FF]"></i>
                            <div>
                                <p class="font-bold text-sm">${fileData.name}</p>
                                <p class="text-xs text-gray-400">${formatFileSize(fileData.size)}</p>
                            </div>
                            <button class="ml-auto text-[#00D4FF] hover:text-[#0099FF]" onclick="downloadFile('${fileData.data}', '${fileData.name}')">
                                <i class="fa-solid fa-download"></i>
                            </button>
                        `;
                        fileDiv.appendChild(fileInfo);
                    }
                    
                    bubble.appendChild(fileDiv);
                } else {
                    // Text message
                    const messageText = document.createElement('p');
                    messageText.className = 'p-3';
                    messageText.textContent = text;
                    bubble.appendChild(messageText);
                }
                
                messageDiv.appendChild(bubble);
            }
            
            container.appendChild(messageDiv);
            
            // Scroll to bottom
            const messagesContainer = isMobile ? 
                document.getElementById('mobile-messages-container') : 
                document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function downloadFile(dataUrl, fileName) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- FILE SHARING FUNCTIONS ---
        function toggleFileUpload() {
            const modal = document.getElementById('file-modal');
            modal.classList.remove('hidden');
            
            // Setup file dropzone
            const dropzone = document.getElementById('file-dropzone');
            const fileInput = document.getElementById('file-input');
            
            dropzone.onclick = () => fileInput.click();
            
            dropzone.ondragover = (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            };
            
            dropzone.ondragleave = () => {
                dropzone.classList.remove('drag-over');
            };
            
            dropzone.ondrop = (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            };
            
            fileInput.onchange = (e) => {
                if (e.target.files.length) {
                    handleFileSelect(e.target.files[0]);
                }
            };
        }
        
        function toggleMobileFileUpload() {
            toggleFileUpload();
        }
        
        function handleFileSelect(file) {
            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large! Maximum size is 5MB.');
                return;
            }
            
            appState.fileToSend = file;
            
            // Show preview
            const preview = document.getElementById('file-preview');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const sendFileBtn = document.getElementById('send-file-btn');
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            preview.classList.remove('hidden');
            sendFileBtn.disabled = false;
            
            // If it's an image, show thumbnail
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // You could show thumbnail here if needed
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeFile() {
            appState.fileToSend = null;
            document.getElementById('file-preview').classList.add('hidden');
            document.getElementById('file-input').value = '';
            document.getElementById('send-file-btn').disabled = true;
        }
        
        function sendFile() {
            if (!appState.fileToSend || !appState.isChatting || !appState.partner) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileData = {
                    name: appState.fileToSend.name,
                    type: appState.fileToSend.type,
                    size: appState.fileToSend.size,
                    data: e.target.result
                };
                
                // Add to UI
                addMessage('user', '', true, fileData);
                
                // Send via socket
                if (socket && socket.connected) {
                    socket.emit('file', {
                        to: appState.partner.userId,
                        file: fileData,
                        sender: appState.userId
                    });
                }
                
                // Close modal
                closeFileModal();
                appState.fileToSend = null;
            };
            
            reader.readAsDataURL(appState.fileToSend);
        }
        
        function handleIncomingFile(data) {
            if (data.sender === appState.partner?.userId) {
                addMessage('stranger', '', true, data.file);
            }
        }
        
        // --- UI FUNCTIONS ---
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
        
        function openSettings() {
            // Load current settings
            document.getElementById('display-name').value = appState.userName;
            document.getElementById('gender-select').value = appState.userGender;
            document.getElementById('gender-pref').value = appState.genderPreference;
            document.getElementById('interests-input').value = appState.interests.join(', ');
            
            // Highlight current match speed
            selectMatchSpeed(appState.matchSpeed);
            
            settingsModal.classList.remove('hidden');
            mobileChatSection.classList.add('hidden');
            document.getElementById('mobile-menu').classList.add('hidden');
        }
        
        function closeSettings() {
            settingsModal.classList.add('hidden');
        }
        
        function selectMatchSpeed(speed) {
            appState.matchSpeed = speed;
            
            const fastBtn = document.getElementById('speed-fast');
            const balancedBtn = document.getElementById('speed-balanced');
            
            // Reset both buttons
            fastBtn.classList.remove('border-[#00D4FF]', 'bg-[#00D4FF]/10');
            fastBtn.querySelector('i').classList.remove('text-[#00D4FF]');
            fastBtn.querySelector('i').classList.add('text-gray-400');
            
            balancedBtn.classList.remove('border-[#00D4FF]', 'bg-[#00D4FF]/10');
            balancedBtn.querySelector('i').classList.remove('text-[#00D4FF]');
            balancedBtn.querySelector('i').classList.add('text-gray-400');
            
            // Highlight selected
            if (speed === 'fast') {
                fastBtn.classList.add('border-[#00D4FF]', 'bg-[#00D4FF]/10');
                fastBtn.querySelector('i').classList.remove('text-gray-400');
                fastBtn.querySelector('i').classList.add('text-[#00D4FF]');
            } else {
                balancedBtn.classList.add('border-[#00D4FF]', 'bg-[#00D4FF]/10');
                balancedBtn.querySelector('i').classList.remove('text-gray-400');
                balancedBtn.querySelector('i').classList.add('text-[#00D4FF]');
            }
        }
        
        function startSmartMatching() {
            // Save settings
            appState.userName = document.getElementById('display-name').value || 'Anonymous';
            appState.userGender = document.getElementById('gender-select').value;
            appState.genderPreference = document.getElementById('gender-pref').value;
            
            const interests = document.getElementById('interests-input').value;
            appState.interests = interests ? interests.split(',').map(i => i.trim()).filter(i => i) : ['chat'];
            
            // Update UI
            document.getElementById('user-name').textContent = appState.userName;
            updateGenderDisplay(appState.userGender);
            updateGenderPreferenceDisplay(appState.genderPreference);
            updateInterestsTags();
            
            closeSettings();
            
            // Start searching
            appState.isSearching = true;
            appState.sessionStart = new Date();
            appState.messageCount = 0;
            
            // Show appropriate chat interface
            if (window.innerWidth >= 768) {
                // Desktop
                homeSection.classList.add('hidden');
                desktopChatSection.classList.remove('hidden');
                desktopChatSection.classList.remove('desktop-hidden');
            } else {
                // Mobile
                homeSection.classList.add('hidden');
                mobileChatSection.classList.remove('hidden');
            }
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            document.getElementById('mobile-messages').innerHTML = '';
            
            // Add searching message
            addMessage('system', 'Searching for compatible partner...');
            
            // Start socket connection if not connected
            if (!socket || !socket.connected) {
                connectSocket();
            }
            
            // Request match
            setTimeout(() => {
                if (socket && socket.connected) {
                    socket.emit('findMatch', {
                        userId: appState.userId,
                        name: appState.userName,
                        gender: appState.userGender,
                        genderPreference: appState.genderPreference,
                        interests: appState.interests,
                        matchSpeed: appState.matchSpeed
                    });
                    
                    document.getElementById('matching-algo').textContent = 
                        appState.matchSpeed === 'fast' ? 'Fast Match' : 'Smart Match';
                } else {
                    // Simulate match for demo
                    simulateMatch();
                }
            }, 1000);
            
            // Start session timer
            updateSessionTimer();
        }
        
        function simulateMatch() {
            // Simulated matching for demo
            setTimeout(() => {
                const simulatedPartner = {
                    userId: 'partner_' + Math.random().toString(36).substr(2, 9),
                    name: ['Alex', 'Taylor', 'Jordan', 'Casey', 'Riley'][Math.floor(Math.random() * 5)],
                    gender: ['male', 'female', 'other'][Math.floor(Math.random() * 3)],
                    interests: appState.interests.concat(['chatting', 'meeting people'])
                };
                
                handleMatchFound(simulatedPartner);
            }, 2000);
        }
        
        function updateInterestsTags() {
            const container = document.getElementById('interests-tags');
            container.innerHTML = '';
            
            appState.interests.forEach(interest => {
                if (interest.trim()) {
                    const tag = document.createElement('span');
                    tag.className = 'px-2 py-0.5 md:px-3 md:py-1 bg-white/5 rounded-full text-xs';
                    tag.textContent = `#${interest.trim()}`;
                    container.appendChild(tag);
                }
            });
        }
        
        function updateStats() {
            document.getElementById('message-count').textContent = appState.messageCount;
            document.getElementById('partner-count').textContent = appState.partnerCount;
        }
        
        function updateSessionTimer() {
            if (appState.sessionStart && (appState.isChatting || appState.isSearching)) {
                const now = new Date();
                const diff = Math.floor((now - appState.sessionStart) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                document.getElementById('session-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                setTimeout(updateSessionTimer, 1000);
            }
        }
        
        function skipPartner() {
            if (appState.isChatting) {
                addMessage('system', 'Looking for new partner...');
                
                if (socket && socket.connected) {
                    socket.emit('skipPartner', { userId: appState.userId });
                }
                
                endChat();
                setTimeout(() => {
                    appState.isSearching = true;
                    appState.partner = null;
                    appState.messageCount = 0;
                    updateStats();
                    
                    if (socket && socket.connected) {
                        socket.emit('findMatch', {
                            userId: appState.userId,
                            name: appState.userName,
                            gender: appState.userGender,
                            genderPreference: appState.genderPreference,
                            interests: appState.interests,
                            matchSpeed: appState.matchSpeed
                        });
                    } else {
                        simulateMatch();
                    }
                }, 1000);
            }
        }
        
        function endChat() {
            appState.isChatting = false;
            appState.partner = null;
            
            // Disable inputs
            const messageInput = document.getElementById('message-input');
            const mobileMessageInput = document.getElementById('mobile-message-input');
            const sendBtn = document.getElementById('send-btn');
            const mobileSendBtn = document.getElementById('mobile-send-btn');
            
            if (messageInput) messageInput.disabled = true;
            if (mobileMessageInput) mobileMessageInput.disabled = true;
            if (sendBtn) sendBtn.disabled = true;
            if (mobileSendBtn) mobileSendBtn.disabled = true;
            
            // Show end message
            addMessage('system', 'Chat ended. Searching for new partner...');
        }
        
        function closeMobileChat() {
            mobileChatSection.classList.add('hidden');
            homeSection.classList.remove('hidden');
            endChat();
        }
        
        function closeFileModal() {
            document.getElementById('file-modal').classList.add('hidden');
            removeFile();
        }
        
        function openServerInfo() {
            serverInfoModal.classList.remove('hidden');
        }
        
        function closeServerInfo() {
            serverInfoModal.classList.add('hidden');
        }
        
        function reconnectServer() {
            if (socket) {
                socket.disconnect();
            }
            connectSocket();
            closeServerInfo();
        }
        
        function disconnectServer() {
            if (socket) {
                socket.disconnect();
                updateServerStatus('Disconnected', 'red-400');
            }
            closeServerInfo();
        }
        
        function retryConnection() {
            if (socket) {
                socket.disconnect();
            }
            connectSocket();
        }
        
        function changeGenderPref() {
            const currentPref = appState.genderPreference;
            const prefs = ['any', 'male', 'female', 'same', 'opposite'];
            const currentIndex = prefs.indexOf(currentPref);
            const nextIndex = (currentIndex + 1) % prefs.length;
            
            appState.genderPreference = prefs[nextIndex];
            updateGenderPreferenceDisplay(appState.genderPreference);
            
            if (appState.isChatting) {
                addMessage('system', `Changed gender preference to: ${appState.genderPreference}`);
            }
            
            // Show notification
            showNotification(`Gender preference updated to: ${appState.genderPreference}`);
        }
        
        function showNotification(message) {
            // Create temporary notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 z-50 glass-card px-4 py-3 rounded-xl animate-slide-up';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-circle-check text-green-400"></i>
                    <span class="text-sm">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // --- ERROR HANDLING ---
        function handleDisconnect(reason) {
            isConnected = false;
            updateServerStatus('Disconnected', 'red-400');
            document.getElementById('server-status').textContent = `Disconnected: ${reason}`;
            
            if (appState.isChatting) {
                addMessage('system', 'Disconnected from server. Trying to reconnect...');
            }
        }
        
        function handleConnectionError(error) {
            console.error('Connection error:', error);
            document.getElementById('server-status').textContent = `Connection failed: ${error.message}`;
            reconnectAttempts++;
            
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                document.getElementById('server-status').textContent = 'Failed to connect. Please check your internet.';
            }
        }
        
        function handlePartnerDisconnect() {
            if (appState.isChatting) {
                addMessage('system', 'Partner disconnected. Searching for new match...');
                endChat();
                setTimeout(() => {
                    skipPartner();
                }, 2000);
            }
        }
        
        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', function() {
            // Generate initial user ID
            appState.userId = generateId();
            
            // Update initial displays
            updateGenderDisplay(appState.userGender);
            updateGenderPreferenceDisplay(appState.genderPreference);
            updateInterestsTags();
            
            // Auto-resize textareas
            const messageInput = document.getElementById('message-input');
            const mobileMessageInput = document.getElementById('mobile-message-input');
            
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
            
            if (mobileMessageInput) {
                mobileMessageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
            
            // Connect to server
            connectSocket();
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Send message on Enter (but not Shift+Enter)
                if (e.key === 'Enter' && !e.shiftKey) {
                    const activeElement = document.activeElement;
                    if (activeElement === messageInput || activeElement === mobileMessageInput) {
                        e.preventDefault();
                        if (window.innerWidth >= 768) {
                            sendMessage();
                        } else {
                            sendMobileMessage();
                        }
                    }
                }
                
                // Escape to end chat
                if (e.key === 'Escape' && appState.isChatting) {
                    endChat();
                }
            });
            
            // Handle window resize
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    // Adjust UI based on screen size
                    if (window.innerWidth < 768 && appState.isChatting) {
                        desktopChatSection.classList.add('hidden');
                        mobileChatSection.classList.remove('hidden');
                    } else if (window.innerWidth >= 768 && appState.isChatting) {
                        mobileChatSection.classList.add('hidden');
                        desktopChatSection.classList.remove('hidden');
                        desktopChatSection.classList.remove('desktop-hidden');
                    }
                }, 250);
            });
        });
    </script>
</body>
</html>

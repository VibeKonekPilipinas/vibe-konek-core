<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Vibe Konek | Anonymous P2P Connections</title>
  
  	 <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,300;12..96,600;12..96,800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vibe-yellow': '#FACC15',
                        'vibe-black': '#030408',
                        'vibe-glass': 'rgba(255, 255, 255, 0.03)',
                        'vibe-border': 'rgba(255, 255, 255, 0.12)',
                        'vibe-cyan': '#22D3EE',
                        'vibe-purple': '#A855F7',
                        'vibe-pink': '#F472B6',
                        'vibe-green': '#4ADE80',
                        'vibe-red': '#F87171'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Bricolage Grotesque', 'sans-serif'],
                    },
                    animation: {
                        'liquid-blob': 'liquid-blob 20s infinite alternate',
                        'marquee': 'marquee 40s linear infinite',
                        'float-soft': 'float-soft 6s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 3s ease-in-out infinite',
                        'shine': 'shine 3s infinite',
                        'radar': 'radar 4s linear infinite',
                        'spin-slow': 'spin 8s linear infinite',
                        'spin-reverse': 'spin-reverse 12s linear infinite',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'typing-dots': 'typingDots 1.4s infinite'
                    },
                    keyframes: {
                        'liquid-blob': {
                            '0%': { transform: 'translate(0, 0) scale(1) rotate(0deg)' },
                            '33%': { transform: 'translate(50px, -80px) scale(1.2) rotate(120deg)' },
                            '66%': { transform: 'translate(-40px, 40px) scale(0.8) rotate(240deg)' },
                            '100%': { transform: 'translate(0, 0) scale(1) rotate(360deg)' },
                        },
                        marquee: {
                            '0%': { transform: 'translateX(0%)' },
                            '100%': { transform: 'translateX(-50%)' },
                        },
                        'float-soft': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-15px)' },
                        },
                        'shine': {
                            '0%': { backgroundPosition: '-200% center' },
                            '100%': { backgroundPosition: '200% center' }
                        },
                        radar: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' }
                        },
                        'spin-reverse': {
                            'from': { transform: 'rotate(360deg)' },
                            'to': { transform: 'rotate(0deg)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        typingDots: {
                            '0%, 60%, 100%': { transform: 'scale(0.6)', opacity: '0.5' },
                            '30%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #030408;
            color: #F8FAFC;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-noise::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.04;
            pointer-events: none;
            z-index: 10;
        }

        .liquid-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            filter: blur(120px);
            opacity: 0.4;
        }

        .blob-unit {
            position: absolute;
            border-radius: 50%;
            mix-blend-mode: screen;
        }

        .glass-hyper {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(28px) saturate(200%);
            -webkit-backdrop-filter: blur(28px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .glass-hyper:hover {
            border-color: rgba(250, 204, 21, 0.4);
            transform: translateY(-8px) scale(1.01);
            background: rgba(255, 255, 255, 0.08);
        }

        .glass-hyper-static {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(28px) saturate(200%);
            -webkit-backdrop-filter: blur(28px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .logo-container {
            background: linear-gradient(90deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 100px;
            padding: 10px 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.4s ease;
            position: relative;
        }
        
        .logo-container:hover {
            transform: scale(1.03);
            border-color: rgba(250, 204, 21, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .shimmer-liquid {
            background: linear-gradient(135deg, #FACC15 0%, #FFFFFF 40%, #22D3EE 60%, #FACC15 100%);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 6s linear infinite;
        }

        .btn-liquid {
            position: relative;
            background: #FACC15;
            color: #000;
            overflow: hidden;
            transition: all 0.3s ease;
            font-weight: 800;
        }

        .btn-liquid:hover {
            transform: translateY(-2px);
        }

        .modal-liquid-bg {
            background: rgba(1, 2, 4, 0.9);
            backdrop-filter: blur(40px);
        }

        .text-readable-title { color: #FFFFFF; }
        .text-readable-body { color: #E2E8F0; } 
        .text-readable-muted { color: #CBD5E1; } 

        .no-scroll { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(250, 204, 21, 0.5); border-radius: 20px; }

        input:focus, select:focus {
            outline: none;
            border-color: #FACC15 !important;
            background: rgba(255, 255, 255, 0.08) !important;
        }

        /* Chat Bubble Styles */
        .bubble-me {
            background: linear-gradient(135deg, #FACC15, #FBBF24);
            color: #000;
            border-radius: 20px 20px 4px 20px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .bubble-them {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #E2E8F0;
            border-radius: 20px 20px 20px 4px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .bubble-system {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.2);
            color: #A5F3FC;
            border-radius: 12px;
            max-width: 85%;
            margin: 0 auto;
            padding: 8px 12px;
        }

        /* File Preview Styles */
        .file-preview {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s ease;
        }

        .file-preview:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #FACC15;
        }

        /* Video/Audio Room Styles */
        .video-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .participant-tile {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(250, 204, 21, 0.3);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }

        /* Interest Tag Styles */
        .interest-tag {
            background: rgba(250, 204, 21, 0.1);
            border: 1px solid rgba(250, 204, 21, 0.3);
            color: #FACC15;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Loading Screen Specifics */
        .radar-sweep {
            background: conic-gradient(from 0deg, rgba(250, 204, 21, 0.4) 0%, transparent 50%);
        }
        .mesh-bg {
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .loading-ring {
            border: 2px solid transparent;
            border-top-color: rgba(250, 204, 21, 0.5);
            border-bottom-color: rgba(34, 211, 238, 0.5);
        }
    </style>
</head>

<body class="antialiased glass-noise">
    <!-- Connecting Overlay (Full Screen) -->
    <div id="connectingOverlay" class="fixed inset-0 z-[200] bg-vibe-black flex flex-col items-center justify-center opacity-0 pointer-events-none transition-all duration-700 overflow-hidden">
        <!-- Mesh Background -->
        <div class="absolute inset-0 mesh-bg opacity-30"></div>
        
        <!-- Radar Visualization Container -->
        <div class="relative w-80 h-80 mb-16 flex items-center justify-center">
            <!-- Outermost Rotating Ring -->
            <div class="absolute inset-0 rounded-full border-2 border-white/5 animate-spin-slow"></div>
            <div class="absolute inset-0 rounded-full border-t-2 border-vibe-yellow/30 animate-spin-slow"></div>
            
            <!-- Mid Ring -->
            <div class="absolute inset-8 rounded-full border border-vibe-cyan/20 animate-spin-reverse"></div>
            <div class="absolute inset-8 rounded-full border-b-2 border-vibe-cyan/40 animate-spin-reverse"></div>
            
            <!-- Signal Rings -->
            <div class="absolute inset-16 rounded-full border border-white/5"></div>
            <div class="absolute inset-24 rounded-full border border-white/5"></div>
            
            <!-- The Radar Sweep -->
            <div class="absolute inset-0 rounded-full radar-sweep animate-radar"></div>
            
            <!-- Central Bolt -->
            <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                <i class="fa-solid fa-bolt text-vibe-yellow text-6xl animate-pulse filter drop-shadow-[0_0_20px_rgba(250,204,21,0.6)]"></i>
                <span class="text-[9px] font-black text-vibe-yellow tracking-[0.4em] uppercase mt-4">Active</span>
            </div>

            <!-- Dynamic Nodes (Mock Data points) -->
            <div class="absolute top-10 left-20 w-1.5 h-1.5 bg-vibe-cyan rounded-full animate-pulse shadow-[0_0_10px_#22D3EE]"></div>
            <div class="absolute bottom-20 right-10 w-1.5 h-1.5 bg-vibe-yellow rounded-full animate-pulse shadow-[0_0_10px_#FACC15]" style="animation-delay: 1.2s"></div>
            <div class="absolute top-40 left-5 w-1 h-1 bg-white rounded-full animate-pulse" style="animation-delay: 0.5s"></div>
        </div>

        <div class="relative z-20 text-center">
            <h2 class="font-display text-4xl md:text-6xl font-extrabold text-white tracking-tighter uppercase mb-4 leading-none">
                Searching <br/> <span class="text-vibe-yellow shimmer-liquid">Mesh Layer</span>
            </h2>
            
            <!-- Live Status Log -->
            <div class="flex flex-col items-center gap-2 mb-10">
                <div class="flex items-center gap-3">
                    <span id="loadingStatusText" class="text-[11px] font-black text-vibe-cyan uppercase tracking-[0.6em]">Initializing Node</span>
                    <div class="flex gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-vibe-cyan animate-bounce" style="animation-delay: 0s"></div>
                        <div class="w-1.5 h-1.5 rounded-full bg-vibe-cyan animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-1.5 h-1.5 rounded-full bg-vibe-cyan animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
                <p id="technicalLog" class="text-[9px] font-mono text-white/20 uppercase tracking-[0.3em]">Handshaking WebRTC Port 5001...</p>
            </div>

            <button onclick="cancelConnection()" class="px-12 py-5 glass-hyper rounded-full text-[10px] font-black uppercase tracking-[0.5em] text-white/40 hover:text-vibe-pink hover:border-vibe-pink/50 transition-all active:scale-95 group">
                <i class="fa-solid fa-power-off mr-3 group-hover:rotate-90 transition-transform"></i>
                Abort Protocol
            </button>
        </div>
        
        <!-- Bottom Data Stream Decoration -->
        <div class="absolute bottom-10 left-0 right-0 px-20 flex justify-between opacity-10 pointer-events-none">
            <div class="font-mono text-[8px] space-y-1">
                <p>LATENCY: 12ms</p>
                <p>NODES: 14,882</p>
                <p>PKT_LOSS: 0.00%</p>
            </div>
            <div class="font-mono text-[8px] space-y-1 text-right">
                <p>AES_256_ACTIVE</p>
                <p>WEBRTC_STABLE</p>
                <p>GENESIS_SYNC</p>
            </div>
        </div>
    </div>

    <!-- Dynamic Liquid Background -->
    <div class="liquid-canvas">
        <div class="blob-unit w-[600px] h-[600px] bg-vibe-yellow top-[-10%] left-[-15%] animate-liquid-blob"></div>
        <div class="blob-unit w-[500px] h-[500px] bg-vibe-cyan top-[30%] right-[-10%] animate-liquid-blob" style="animation-delay: -5s;"></div>
        <div class="blob-unit w-[450px] h-[450px] bg-vibe-purple bottom-[10%] left-[20%] animate-liquid-blob" style="animation-delay: -10s;"></div>
    </div>

    <!-- Navigation Header -->
    <header id="mainHeader" class="fixed top-8 left-8 z-50 transition-opacity duration-500 ease-in-out">
        <div class="logo-container group cursor-pointer" onclick="showPage('home')">
            <i class="fa-solid fa-bolt text-vibe-yellow text-2xl filter drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]"></i>
            <span class="font-display font-extrabold text-xl tracking-tighter uppercase text-white">
                Vibe <span class="text-vibe-yellow">Konek</span>
            </span>
        </div>
    </header>

    <!-- Scroll to Top Button -->
    <button id="scrollTopBtn" onclick="window.scrollTo({top:0, behavior:'smooth'})" class="fixed bottom-8 right-8 z-[70] w-14 h-14 glass-hyper rounded-full flex items-center justify-center text-vibe-yellow text-xl opacity-0 pointer-events-none translate-y-10 transition-all duration-500 hover:scale-110 active:scale-95 backdrop-blur-xl border border-white/20">
        <i class="fa-solid fa-arrow-up"></i>
    </button>

    <!-- Modal System -->
    <div id="modalOverlay" class="fixed inset-0 z-[100] flex items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-500 modal-liquid-bg" onclick="handleOverlayClick(event)">
        <div class="modal-box w-full max-w-2xl glass-hyper rounded-[3rem] overflow-hidden flex flex-col transform scale-90 transition-all duration-500">
            <div class="p-8 border-b border-white/10 flex items-center justify-between">
                <div class="flex items-center gap-5">
                    <button id="modalBackBtn" class="hidden w-12 h-12 rounded-full bg-white/5 items-center justify-center hover:bg-white/10 transition-colors text-white mr-2 active:scale-90">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div class="w-14 h-14 bg-vibe-yellow/20 rounded-2xl flex items-center justify-center border border-vibe-yellow/30">
                        <i id="modalIcon" class="fa-solid fa-bolt text-vibe-yellow text-2xl"></i>
                    </div>
                    <div>
                        <h3 id="modalTitle" class="font-display text-3xl font-extrabold uppercase tracking-tight text-white">Title</h3>
                        <p id="modalSubtitle" class="text-[10px] text-vibe-yellow uppercase tracking-widest mt-1 font-black">Protocol Intelligence</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors text-white active:scale-90">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div id="modalBody" class="p-10 md:p-12 overflow-y-auto text-readable-body text-lg leading-relaxed max-h-[70vh]"></div>
        </div>
    </div>

    <!-- ==================== MAIN PAGES ==================== -->
    
    <!-- Homepage (Visible by default) -->
    <main id="homePage" class="relative pt-48 pb-16 px-6 max-w-6xl mx-auto flex flex-col items-center">
        <!-- Hero Section -->
        <div class="text-center w-full max-w-5xl mb-24 flex flex-col items-center">
            <h1 class="font-display text-6xl sm:text-7xl md:text-[120px] font-extrabold tracking-tighter leading-[0.8] mb-12 shimmer-liquid">
                KONEK <br/>
                IN A <span class="text-vibe-yellow">FLASH.</span>
            </h1>
            <p class="text-readable-body text-xl sm:text-2xl md:text-4xl font-light leading-snug px-4 max-w-4xl">
                Sync with the speed of <span class="text-vibe-yellow font-bold italic">Vibe.</span> Hyper-fast, anonymous, and unfiltered. <span class="text-white font-medium">No accounts, no noise.</span> Just real connection on a global layer.
            </p>
        </div>

        <!-- Action Grid -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8 w-full max-w-6xl mb-24">
            <div class="md:col-span-8 md:row-span-2 glass-hyper rounded-[4rem] p-10 md:p-16 flex flex-col justify-between overflow-hidden relative group min-h-[500px] transition-all duration-500 hover:-translate-y-2 hover:scale-[1.01] hover:border-vibe-yellow/40">
                <div class="relative z-10">
                    <div class="flex items-center gap-4 mb-10">
                        <i class="fa-solid fa-bolt-lightning text-vibe-yellow text-3xl animate-pulse"></i>
                        <span class="text-xs font-black uppercase tracking-[0.5em] text-vibe-yellow">Live Node Sync</span>
                    </div>
                    <h2 class="font-display text-5xl md:text-8xl font-extrabold tracking-tighter mb-8 text-white leading-tight">Enter the <br/>Vibe</h2>
                    <p class="text-readable-body text-xl md:text-2xl leading-relaxed max-w-md font-light">Instantly pair with the world. Your identity stays yours, your data vanishes on exit.</p>
                </div>

                <div class="flex flex-col md:flex-row gap-5 mt-14 relative z-10 w-full">
                    <button onclick="openSetup('chat')" class="btn-liquid flex-1 px-4 py-7 rounded-[2rem] font-black text-sm uppercase tracking-[0.4em] flex items-center justify-center gap-4 hover:scale-105 active:scale-95 transition-all min-w-0">
                        <i class="fa-solid fa-comments text-2xl"></i>
                        <span class="truncate">Chat</span>
                    </button>
                    <button onclick="openSetup('audio')" class="bg-vibe-cyan text-vibe-black flex-1 px-4 py-7 rounded-[2rem] font-black text-sm uppercase tracking-[0.4em] flex items-center justify-center gap-4 hover:scale-105 active:scale-95 transition-all min-w-0">
                        <i class="fa-solid fa-microphone text-2xl"></i>
                        <span class="truncate">Audio</span>
                    </button>
                    <button onclick="openSetup('video')" class="bg-white text-black flex-1 px-4 py-7 rounded-[2rem] font-black text-sm uppercase tracking-[0.4em] flex items-center justify-center gap-4 hover:scale-105 active:scale-95 transition-all min-w-0">
                        <i class="fa-solid fa-video text-2xl"></i>
                        <span class="truncate">Video</span>
                    </button>
                </div>
                
                <i class="fa-solid fa-bolt absolute -bottom-32 -right-32 text-[400px] md:text-[550px] text-white/[0.03] group-hover:text-vibe-yellow/[0.07] transition-all duration-1000 rotate-[15deg]"></i>
            </div>

            <!-- Side Features -->
            <div class="md:col-span-4 glass-hyper rounded-[3.5rem] p-10 flex flex-col justify-between transition-all duration-500 hover:-translate-y-2 hover:scale-[1.02] hover:border-vibe-cyan/40">
                <div class="w-16 h-16 rounded-2xl bg-vibe-cyan/20 border border-vibe-cyan/30 flex items-center justify-center text-vibe-cyan text-3xl">
                    <i class="fa-solid fa-fingerprint"></i>
                </div>
                <div class="mt-12">
                    <h3 class="font-display font-extrabold text-3xl mb-3 text-white">Stealth Mode</h3>
                    <p class="text-readable-muted text-base leading-relaxed">Hardware-isolated anonymity. No trace, no tracking left behind.</p>
                </div>
            </div>

            <div class="md:col-span-4 glass-hyper rounded-[3.5rem] p-10 flex flex-col justify-between transition-all duration-500 hover:-translate-y-2 hover:scale-[1.02] hover:border-vibe-purple/40">
                <div class="w-16 h-16 rounded-2xl bg-vibe-purple/20 border border-vibe-purple/30 flex items-center justify-center text-vibe-purple text-3xl">
                    <i class="fa-solid fa-gauge-high"></i>
                </div>
                <div class="mt-12">
                    <h3 class="font-display font-extrabold text-3xl mb-3 text-white">Edge Sync</h3>
                    <p class="text-readable-muted text-base leading-relaxed">Ultra-low latency pairing powered by next-gen global nodes.</p>
                </div>
            </div>

            <div class="md:col-span-12 glass-hyper rounded-[4rem] p-10 md:p-14 flex flex-col md:flex-row items-center justify-between gap-12 transition-all duration-500 hover:-translate-y-2 hover:scale-[1.01] hover:border-white/20">
                <div class="flex flex-col sm:flex-row items-center gap-12 md:gap-24">
                    <div class="group text-center sm:text-left">
                        <span class="block text-5xl md:text-6xl font-display font-black text-vibe-yellow group-hover:scale-110 transition-transform">9M+</span>
                        <span class="text-[11px] uppercase tracking-[0.5em] text-white/50 font-black mt-3">Daily Vibes</span>
                    </div>
                    <div class="h-16 w-px bg-white/10 hidden sm:block"></div>
                    <div class="text-center sm:text-left">
                        <span class="block text-5xl md:text-6xl font-display font-black text-vibe-cyan">182</span>
                        <span class="text-[11px] uppercase tracking-[0.5em] text-white/50 font-black mt-3">Country Nodes</span>
                    </div>
                </div>
                <div class="flex -space-x-5">
                    <div class="w-16 h-16 rounded-full border-4 border-vibe-black bg-vibe-cyan flex items-center justify-center text-sm font-black">V1</div>
                    <div class="w-16 h-16 rounded-full border-4 border-vibe-black bg-vibe-yellow flex items-center justify-center text-sm font-black text-black">K1</div>
                    <div class="w-16 h-16 rounded-full border-4 border-vibe-black bg-vibe-pink flex items-center justify-center text-sm font-black">V2</div>
                    <div class="w-16 h-16 rounded-full border-4 border-vibe-black bg-white/10 backdrop-blur-2xl flex items-center justify-center text-[12px] font-black border-white/10 text-white">+12k</div>
                </div>
            </div>
        </div>
    </main>

    <!-- ==================== CHAT/AUDIO/VIDEO SCREENS (HIDDEN) ==================== -->
    
    <!-- 1v1 Chat Screen -->
    <div id="chatScreen" class="hidden fixed inset-0 z-40 bg-vibe-black">
        <div class="container mx-auto px-4 h-full flex flex-col py-20">
            <!-- Chat Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <button onclick="showPage('home')" class="w-12 h-12 glass-hyper rounded-full flex items-center justify-center hover:scale-105 transition-transform">
                        <i class="fa-solid fa-arrow-left text-vibe-yellow"></i>
                    </button>
                    <div>
                        <h2 class="font-display text-2xl font-bold text-white">Chat Room</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <div id="partnerStatus" class="w-2 h-2 rounded-full bg-vibe-green animate-pulse"></div>
                            <span id="partnerName" class="text-sm text-vibe-cyan">Stranger</span>
                            <div id="commonInterests" class="flex gap-1"></div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleMute()" id="muteBtn" class="w-10 h-10 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                        <i class="fa-solid fa-microphone text-white"></i>
                    </button>
                    <button onclick="leaveChat()" class="w-10 h-10 glass-hyper rounded-full flex items-center justify-center hover:scale-105 bg-vibe-red/20 border-vibe-red/30">
                        <i class="fa-solid fa-phone-slash text-vibe-red"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="flex-1 glass-hyper rounded-3xl overflow-hidden flex flex-col">
                <!-- Messages Area -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Messages will appear here -->
                    <div class="text-center text-vibe-cyan/60 py-8">
                        <i class="fa-solid fa-comment-dots text-4xl mb-3"></i>
                        <p class="text-sm">Connected to mesh network. Start chatting!</p>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="hidden px-6 py-2">
                    <div class="flex items-center gap-2 text-vibe-cyan text-sm">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-vibe-cyan rounded-full animate-typing-dots"></div>
                            <div class="w-2 h-2 bg-vibe-cyan rounded-full animate-typing-dots" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-vibe-cyan rounded-full animate-typing-dots" style="animation-delay: 0.4s"></div>
                        </div>
                        <span id="typingName">Someone</span> is typing...
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t border-white/10 p-4">
                    <div class="flex items-center gap-3">
                        <label class="w-10 h-10 glass-hyper rounded-full flex items-center justify-center cursor-pointer hover:scale-105 transition-transform">
                            <i class="fa-solid fa-paperclip text-vibe-yellow"></i>
                            <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf,.doc,.txt">
                        </label>
                        <div class="flex-1 relative">
                            <input type="text" id="messageInput" 
                                   placeholder="Type your message..." 
                                   class="w-full glass-hyper py-3 px-4 rounded-full pr-12 focus:outline-none focus:border-vibe-yellow">
                            <button onclick="sendMessage()" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-vibe-yellow rounded-full flex items-center justify-center hover:scale-105">
                                <i class="fa-solid fa-paper-plane text-black"></i>
                            </button>
                        </div>
                        <button onclick="nextPartner()" class="w-10 h-10 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                            <i class="fa-solid fa-rotate text-vibe-cyan"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 1v1 Video Screen -->
    <div id="videoScreen" class="hidden fixed inset-0 z-40 bg-vibe-black">
        <div class="container mx-auto px-4 h-full flex flex-col py-4">
            <!-- Video Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                    <button onclick="showPage('home')" class="w-12 h-12 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                        <i class="fa-solid fa-arrow-left text-vibe-yellow"></i>
                    </button>
                    <div>
                        <h2 class="font-display text-xl font-bold text-white">Video Call</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <div id="videoPartnerStatus" class="w-2 h-2 rounded-full bg-vibe-green animate-pulse"></div>
                            <span id="videoPartnerName" class="text-sm text-vibe-cyan">Stranger</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="videoCommonInterests" class="flex gap-1"></div>
                    <div id="videoPartnerInfo" class="text-xs text-white/60 hidden">
                        <span id="partnerGender"></span> â€¢ <span id="partnerLocation"></span>
                    </div>
                </div>
            </div>

            <!-- Video Container -->
            <div class="flex-1 relative rounded-3xl overflow-hidden">
                <!-- Remote Video -->
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover bg-vibe-black"></video>
                
                <!-- Local Video (PiP) -->
                <div class="absolute bottom-4 right-4 w-48 h-32 bg-vibe-black rounded-xl overflow-hidden border-2 border-vibe-yellow">
                    <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
                    <div class="absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-xs text-white">
                        You
                    </div>
                </div>

                <!-- Controls -->
                <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex items-center gap-4">
                    <button onclick="toggleVideo()" id="videoToggle" class="w-14 h-14 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                        <i class="fa-solid fa-video text-white text-xl"></i>
                    </button>
                    <button onclick="toggleMute()" id="audioToggle" class="w-14 h-14 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                        <i class="fa-solid fa-microphone text-white text-xl"></i>
                    </button>
                    <button onclick="toggleScreenShare()" id="screenShare" class="w-14 h-14 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                        <i class="fa-solid fa-display text-white text-xl"></i>
                    </button>
                    <button onclick="leaveVideoCall()" class="w-14 h-14 bg-vibe-red rounded-full flex items-center justify-center hover:scale-105">
                        <i class="fa-solid fa-phone-slash text-white text-xl"></i>
                    </button>
                </div>

                <!-- Status Overlay -->
                <div id="videoStatus" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                    <div class="loader mb-4"><span></span><span></span><span></span></div>
                    <p class="text-vibe-yellow font-bold tracking-widest animate-pulse">CONNECTING...</p>
                </div>
            </div>

            <!-- Chat Panel (Collapsible) -->
            <div id="videoChatPanel" class="mt-4 glass-hyper rounded-3xl p-4 max-h-64 overflow-hidden transition-all duration-300">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-white">Chat</h3>
                    <button onclick="toggleChatPanel()" class="text-vibe-cyan">
                        <i class="fa-solid fa-chevron-up"></i>
                    </button>
                </div>
                <div id="videoChatMessages" class="overflow-y-auto max-h-32 mb-3 space-y-2">
                    <!-- Video chat messages -->
                </div>
                <div class="flex gap-2">
                    <input type="text" id="videoChatInput" placeholder="Type message..." class="flex-1 glass-hyper py-2 px-3 rounded-full text-sm">
                    <button onclick="sendVideoChat()" class="w-8 h-8 bg-vibe-yellow rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane text-black text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Video/Audio Room -->
    <div id="groupScreen" class="hidden fixed inset-0 z-40 bg-vibe-black">
        <div class="container mx-auto px-4 h-full flex flex-col py-4">
            <!-- Group Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                    <button onclick="showPage('home')" class="w-12 h-12 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                        <i class="fa-solid fa-arrow-left text-vibe-yellow"></i>
                    </button>
                    <div>
                        <h2 class="font-display text-xl font-bold text-white">Group Session</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="w-2 h-2 rounded-full bg-vibe-green animate-pulse"></div>
                            <span class="text-sm text-vibe-cyan"><span id="participantCount">1</span> Participants</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="inviteToGroup()" class="px-4 py-2 glass-hyper rounded-full text-sm hover:scale-105">
                        <i class="fa-solid fa-user-plus mr-2"></i>Invite
                    </button>
                    <button onclick="leaveGroup()" class="px-4 py-2 bg-vibe-red/20 border border-vibe-red/30 rounded-full text-sm hover:scale-105">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i>Leave
                    </button>
                </div>
            </div>

            <!-- Participants Grid -->
            <div id="participantsGrid" class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Participants will be added here -->
                <div class="participant-tile flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-20 h-20 rounded-full bg-vibe-cyan/20 flex items-center justify-center mb-3">
                            <i class="fa-solid fa-user text-vibe-cyan text-3xl"></i>
                        </div>
                        <p class="text-white font-semibold">You</p>
                        <p class="text-xs text-vibe-cyan">Host</p>
                    </div>
                </div>
            </div>

            <!-- Group Controls -->
            <div class="mt-4 flex justify-center gap-6">
                <button onclick="toggleGroupVideo()" class="w-14 h-14 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                    <i class="fa-solid fa-video text-white text-xl"></i>
                </button>
                <button onclick="toggleGroupAudio()" class="w-14 h-14 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                    <i class="fa-solid fa-microphone text-white text-xl"></i>
                </button>
                <button onclick="toggleGroupScreenShare()" class="w-14 h-14 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                    <i class="fa-solid fa-display text-white text-xl"></i>
                </button>
                <button onclick="toggleGroupChat()" class="w-14 h-14 glass-hyper rounded-full flex items-center justify-center hover:scale-105">
                    <i class="fa-solid fa-comment text-white text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>

        // --- GLOBAL STATE ---
        const socket = io("https://vibe-konek-core.onrender.com");
        
        let currentMode = null; // 'chat', 'audio', 'video', 'group'
        let currentRoom = null;
        let currentPartner = null;
        let currentUser = {
            id: null,
            name: 'Guest',
            gender: 'Not specified',
            interests: [],
            location: 'Global'
        };
        
        let isConnected = false;
        let isMuted = false;
        let isVideoOff = false;
        let isScreenSharing = false;
        
        // WebRTC
        let localStream = null;
        let peerConnection = null;
        let dataChannel = null;
        
        // Typing
        let typingTimeout = null;
        let partnerTyping = false;
        
        // File handling
        let pendingFile = null;
        
        // --- DOM ELEMENTS ---
        const homePage = document.getElementById('homePage');
        const chatScreen = document.getElementById('chatScreen');
        const videoScreen = document.getElementById('videoScreen');
        const groupScreen = document.getElementById('groupScreen');
        
        // --- UI FUNCTIONS ---
        function showPage(page) {
            // Hide all pages
            homePage.classList.add('hidden');
            chatScreen.classList.add('hidden');
            videoScreen.classList.add('hidden');
            groupScreen.classList.add('hidden');
            
            // Stop any active connections
            if (page !== currentMode) {
                stopConnection();
            }
            
            // Show requested page
            switch(page) {
                case 'home':
                    homePage.classList.remove('hidden');
                    break;
                case 'chat':
                    chatScreen.classList.remove('hidden');
                    break;
                case 'video':
                    videoScreen.classList.remove('hidden');
                    break;
                case 'group':
                    groupScreen.classList.remove('hidden');
                    break;
            }
            
            // Update header visibility
            const header = document.getElementById('mainHeader');
            if (page === 'home') {
                header.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                header.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        function openSetup(mode) {
            currentMode = mode;
            openModal('settings');
        }
        
        // --- MODAL FUNCTIONS (From original) ---
        const modalData = {
            settings: { 
                title: "Configure Connection", 
                icon: "fa-sliders", 
                content: `
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs font-bold text-vibe-yellow uppercase tracking-wider mb-2 block">Display Name</label>
                            <input type="text" id="userName" placeholder="Anonymous" 
                                   class="w-full glass-hyper py-3 px-4 rounded-xl focus:outline-none focus:border-vibe-yellow">
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-vibe-yellow uppercase tracking-wider mb-2 block">Your Interests</label>
                            <input type="text" id="userInterests" placeholder="Gaming, Music, Tech, Anime..." 
                                   class="w-full glass-hyper py-3 px-4 rounded-xl focus:outline-none focus:border-vibe-yellow">
                            <p class="text-xs text-white/50 mt-1">Separate with commas. We'll match you with people who share similar interests.</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-vibe-yellow uppercase tracking-wider mb-2 block">Gender</label>
                                <select id="userGender" class="w-full glass-hyper py-3 px-4 rounded-xl">
                                    <option value="not_specified">Not specified</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="non_binary">Non-binary</option>
                                    <option value="prefer_not">Prefer not to say</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-vibe-yellow uppercase tracking-wider mb-2 block">Connection Type</label>
                                <select id="connectionType" class="w-full glass-hyper py-3 px-4 rounded-xl">
                                    <option value="1v1">One-on-One</option>
                                    <option value="group">Group Session</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-white/10">
                            <button onclick="startConnection()" class="w-full btn-liquid py-4 rounded-xl font-bold text-lg">
                                <i class="fa-solid fa-bolt mr-2"></i> Start Connection
                            </button>
                            <p class="text-xs text-white/50 text-center mt-3">
                                By connecting, you agree to our 
                                <button onclick="openModal('terms')" class="text-vibe-yellow hover:underline">Terms</button> 
                                and 
                                <button onclick="openModal('privacy')" class="text-vibe-yellow hover:underline">Privacy Policy</button>
                            </p>
                        </div>
                    </div>
                ` 
            },
            // ... other modals (terms, privacy, etc.)
        };
        
        function openModal(key) {
            const data = modalData[key];
            if (!data) return;
            
            document.getElementById('modalTitle').innerText = data.title;
            document.getElementById('modalIcon').className = `fa-solid ${data.icon} text-vibe-yellow text-2xl`;
            document.getElementById('modalBody').innerHTML = data.content;
            
            const overlay = document.getElementById('modalOverlay');
            const modalBox = overlay.querySelector('.modal-box');
            
            overlay.classList.add('opacity-100', 'pointer-events-auto');
            modalBox.classList.remove('scale-90');
            modalBox.classList.add('scale-100');
            document.body.classList.add('no-scroll');
            
            // Pre-fill if returning to settings
            if (key === 'settings') {
                document.getElementById('userName').value = currentUser.name;
                document.getElementById('userInterests').value = currentUser.interests.join(', ');
                document.getElementById('userGender').value = currentUser.gender;
            }
        }
        
        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            const modalBox = overlay.querySelector('.modal-box');
            
            overlay.classList.remove('opacity-100', 'pointer-events-auto');
            modalBox.classList.remove('scale-100');
            modalBox.classList.add('scale-90');
            document.body.classList.remove('no-scroll');
        }
        
        function handleOverlayClick(e) {
            if (e.target === document.getElementById('modalOverlay')) {
                closeModal();
            }
        }
        
        // --- CONNECTION LOGIC ---
        function startConnection() {
            // Get user settings
            currentUser.name = document.getElementById('userName').value.trim() || 'Anonymous';
            currentUser.interests = document.getElementById('userInterests').value.split(',').map(i => i.trim()).filter(i => i);
            currentUser.gender = document.getElementById('userGender').value;
            const connectionType = document.getElementById('connectionType').value;
            
            closeModal();
            
            // Show connecting overlay
            const overlay = document.getElementById('connectingOverlay');
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            overlay.classList.add('opacity-100');
            
            // Update loading status
            const statusText = document.getElementById('loadingStatusText');
            const technicalLog = document.getElementById('technicalLog');
            const statuses = ["Authenticating Node", "P2P Handshake", "Signal Mesh Sync", "Encryption Lock", "Finding Peers"];
            const logs = [
                "Tunneling WebRTC Layer...",
                "Negotiating ICE Candidates...",
                "AES-256 Key Exchange...",
                "Routing through Global Mesh...",
                "Establishing Direct Tunnel..."
            ];
            
            let counter = 0;
            const loadingInterval = setInterval(() => {
                counter = (counter + 1) % statuses.length;
                statusText.innerText = statuses[counter];
                technicalLog.innerText = logs[counter];
            }, 1200);
            
            // Emit connection request
            setTimeout(() => {
                clearInterval(loadingInterval);
                overlay.classList.add('opacity-0', 'pointer-events-none');
                
                // For demo: Simulate connection
                if (connectionType === '1v1') {
                    if (currentMode === 'chat') {
                        simulateChatConnection();
                    } else if (currentMode === 'video') {
                        simulateVideoConnection();
                    } else if (currentMode === 'audio') {
                        simulateAudioConnection();
                    }
                } else {
                    simulateGroupConnection();
                }
            }, 5000);
        }
        
        function simulateChatConnection() {
            currentPartner = {
                id: 'partner_' + Date.now(),
                name: 'Stranger',
                gender: 'Unknown',
                interests: ['Gaming', 'Music'],
                location: 'Unknown'
            };
            
            // Show chat screen
            showPage('chat');
            
            // Update UI
            document.getElementById('partnerName').textContent = currentPartner.name;
            document.getElementById('partnerStatus').className = 'w-2 h-2 rounded-full bg-vibe-green';
            
            // Show common interests
            const commonInterests = currentUser.interests.filter(i => 
                currentPartner.interests.map(pi => pi.toLowerCase()).includes(i.toLowerCase())
            );
            updateInterestTags(commonInterests, 'commonInterests');
            
            // Add welcome message
            addSystemMessage(`Connected to ${currentPartner.name}. You both share interests in ${commonInterests.join(', ')}.`);
            
            isConnected = true;
            
            // Simulate partner typing
            setTimeout(() => {
                document.getElementById('typingIndicator').classList.remove('hidden');
                document.getElementById('typingName').textContent = currentPartner.name;
                
                setTimeout(() => {
                    document.getElementById('typingIndicator').classList.add('hidden');
                    addMessage('Hey there! Nice to meet you. How are you?', false);
                }, 2000);
            }, 1000);
        }
        
        function simulateVideoConnection() {
            currentPartner = {
                id: 'partner_' + Date.now(),
                name: 'Alex',
                gender: 'Non-binary',
                interests: ['Tech', 'Music'],
                location: 'USA'
            };
            
            // Show video screen
            showPage('video');
            
            // Update UI
            document.getElementById('videoPartnerName').textContent = currentPartner.name;
            document.getElementById('videoPartnerStatus').className = 'w-2 h-2 rounded-full bg-vibe-green';
            document.getElementById('partnerGender').textContent = currentPartner.gender;
            document.getElementById('partnerLocation').textContent = currentPartner.location;
            document.getElementById('videoPartnerInfo').classList.remove('hidden');
            
            // Show common interests
            const commonInterests = currentUser.interests.filter(i => 
                currentPartner.interests.map(pi => pi.toLowerCase()).includes(i.toLowerCase())
            );
            updateInterestTags(commonInterests, 'videoCommonInterests');
            
            // Hide status overlay
            setTimeout(() => {
                document.getElementById('videoStatus').style.display = 'none';
            }, 2000);
            
            isConnected = true;
            
            // Request media if not already
            if (!localStream) {
                requestMedia();
            }
        }
        
        function simulateGroupConnection() {
            showPage('group');
            
            // Add mock participants
            const participants = [
                { name: 'You', role: 'Host' },
                { name: 'Alex', role: 'Member' },
                { name: 'Sam', role: 'Member' },
                { name: 'Jordan', role: 'Member' }
            ];
            
            updateParticipantGrid(participants);
            document.getElementById('participantCount').textContent = participants.length;
        }
        
        // --- MEDIA HANDLING ---
        async function requestMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: currentMode === 'video' || currentMode === 'group',
                    audio: true
                });
                
                if (currentMode === 'video' && document.getElementById('localVideo')) {
                    document.getElementById('localVideo').srcObject = localStream;
                }
                
                return true;
            } catch (err) {
                console.error('Media error:', err);
                addSystemMessage('Unable to access camera/microphone. Please check permissions.');
                return false;
            }
        }
        
        // --- MESSAGE HANDLING ---
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !isConnected) return;
            
            // Add message to UI
            addMessage(message, true);
            
            // Clear input
            input.value = '';
            
            // In real implementation, send via socket
            // socket.emit('chat_message', { room: currentRoom, message });
            
            // Simulate response
            setTimeout(() => {
                if (isConnected) {
                    const responses = [
                        "That's interesting!",
                        "I feel the same way.",
                        "Tell me more about that.",
                        "Nice to hear that from you.",
                        "What do you think about this topic?"
                    ];
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    addMessage(response, false);
                }
            }, 1000 + Math.random() * 2000);
        }
        
        function sendVideoChat() {
            const input = document.getElementById('videoChatInput');
            const message = input.value.trim();
            
            if (!message || !isConnected) return;
            
            addVideoChatMessage(message, true);
            input.value = '';
        }
        
        function addMessage(text, isMe) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `animate-slide-up ${isMe ? 'text-right' : ''}`;
            messageDiv.innerHTML = `
                <div class="inline-block max-w-[80%] ${isMe ? 'bubble-me' : 'bubble-them'} p-3">
                    <div class="text-xs opacity-70 mb-1">${isMe ? 'You' : currentPartner?.name || 'Stranger'}</div>
                    <div>${text}</div>
                    <div class="text-xs opacity-50 text-right mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addVideoChatMessage(text, isMe) {
            const messagesDiv = document.getElementById('videoChatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `text-sm ${isMe ? 'text-right' : ''}`;
            messageDiv.innerHTML = `
                <div class="inline-block ${isMe ? 'bg-vibe-yellow text-black' : 'bg-white/10 text-white'} rounded-lg px-3 py-2 max-w-[80%]">
                    <span class="font-semibold">${isMe ? 'You' : currentPartner?.name || 'Stranger'}:</span> ${text}
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = 'animate-fade-in text-center';
            messageDiv.innerHTML = `
                <div class="bubble-system inline-block px-4 py-2">
                    <i class="fa-solid fa-info-circle mr-2"></i>${text}
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // --- FILE HANDLING ---
        document.getElementById('fileInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                addSystemMessage('File too large (max 10MB)');
                return;
            }
            
            // Show file preview
            const reader = new FileReader();
            reader.onload = function(e) {
                displayFilePreview(file, e.target.result);
                
                // In real implementation, send file via WebRTC data channel
                // sendFile(file, e.target.result);
            };
            
            if (file.type.startsWith('image/')) {
                reader.readAsDataURL(file);
            } else {
                // For non-image files, just show file info
                displayFilePreview(file, null);
            }
            
            // Reset input
            e.target.value = '';
        });
        
        function displayFilePreview(file, dataUrl) {
            const messagesDiv = document.getElementById('chatMessages');
            const previewDiv = document.createElement('div');
            
            previewDiv.className = 'animate-slide-up text-right';
            
            let previewHTML = `
                <div class="inline-block bubble-me p-3 max-w-[80%]">
                    <div class="text-xs opacity-70 mb-1">You sent a file</div>
                    <div class="file-preview">
            `;
            
            if (dataUrl && file.type.startsWith('image/')) {
                previewHTML += `
                    <img src="${dataUrl}" alt="${file.name}" class="max-w-full h-auto rounded-lg mb-2">
                `;
            }
            
            previewHTML += `
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-file text-vibe-yellow"></i>
                            <div class="flex-1">
                                <div class="font-semibold truncate">${file.name}</div>
                                <div class="text-xs opacity-70">${formatFileSize(file.size)} â€¢ ${file.type}</div>
                            </div>
                            <a href="${dataUrl || '#'}" download="${file.name}" class="text-vibe-yellow hover:text-white">
                                <i class="fa-solid fa-download"></i>
                            </a>
                        </div>
                    </div>
                    <div class="text-xs opacity-50 text-right mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            
            previewDiv.innerHTML = previewHTML;
            messagesDiv.appendChild(previewDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // --- UI UPDATES ---
        function updateInterestTags(interests, elementId) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            container.innerHTML = '';
            interests.slice(0, 3).forEach(interest => {
                const tag = document.createElement('span');
                tag.className = 'interest-tag text-xs';
                tag.textContent = interest;
                container.appendChild(tag);
            });
        }
        
        function updateParticipantGrid(participants) {
            const grid = document.getElementById('participantsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            participants.forEach(participant => {
                const tile = document.createElement('div');
                tile.className = 'participant-tile flex items-center justify-center';
                tile.innerHTML = `
                    <div class="text-center">
                        <div class="w-20 h-20 rounded-full ${participant.role === 'Host' ? 'bg-vibe-yellow/20' : 'bg-vibe-cyan/20'} flex items-center justify-center mb-3">
                            <i class="fa-solid fa-user ${participant.role === 'Host' ? 'text-vibe-yellow' : 'text-vibe-cyan'} text-3xl"></i>
                        </div>
                        <p class="text-white font-semibold">${participant.name}</p>
                        <p class="text-xs ${participant.role === 'Host' ? 'text-vibe-yellow' : 'text-vibe-cyan'}">${participant.role}</p>
                    </div>
                `;
                grid.appendChild(tile);
            });
        }
        
        // --- CONTROLS ---
        function toggleMute() {
            isMuted = !isMuted;
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !isMuted;
                });
            }
            
            const btn = document.getElementById('muteBtn') || document.getElementById('audioToggle');
            if (btn) {
                btn.innerHTML = isMuted 
                    ? '<i class="fa-solid fa-microphone-slash text-vibe-red"></i>'
                    : '<i class="fa-solid fa-microphone text-white"></i>';
                
                if (isMuted) {
                    btn.classList.add('bg-vibe-red/20', 'border-vibe-red/30');
                } else {
                    btn.classList.remove('bg-vibe-red/20', 'border-vibe-red/30');
                }
            }
        }
        
        function toggleVideo() {
            isVideoOff = !isVideoOff;
            if (localStream) {
                localStream.getVideoTracks().forEach(track => {
                    track.enabled = !isVideoOff;
                });
            }
            
            const btn = document.getElementById('videoToggle');
            if (btn) {
                btn.innerHTML = isVideoOff 
                    ? '<i class="fa-solid fa-video-slash text-vibe-red"></i>'
                    : '<i class="fa-solid fa-video text-white"></i>';
                
                if (isVideoOff) {
                    btn.classList.add('bg-vibe-red/20', 'border-vibe-red/30');
                } else {
                    btn.classList.remove('bg-vibe-red/20', 'border-vibe-red/30');
                }
            }
        }
        
        function toggleScreenShare() {
            isScreenSharing = !isScreenSharing;
            const btn = document.getElementById('screenShare');
            
            if (btn) {
                if (isScreenSharing) {
                    btn.classList.add('bg-vibe-cyan/20', 'border-vibe-cyan/30');
                    btn.innerHTML = '<i class="fa-solid fa-display text-vibe-cyan"></i>';
                    addSystemMessage('Screen sharing started');
                } else {
                    btn.classList.remove('bg-vibe-cyan/20', 'border-vibe-cyan/30');
                    btn.innerHTML = '<i class="fa-solid fa-display text-white"></i>';
                    addSystemMessage('Screen sharing stopped');
                }
            }
        }
        
        function toggleChatPanel() {
            const panel = document.getElementById('videoChatPanel');
            const button = panel.querySelector('button');
            
            if (panel.classList.contains('max-h-64')) {
                panel.classList.remove('max-h-64');
                panel.classList.add('max-h-96');
                button.innerHTML = '<i class="fa-solid fa-chevron-down"></i>';
            } else {
                panel.classList.remove('max-h-96');
                panel.classList.add('max-h-64');
                button.innerHTML = '<i class="fa-solid fa-chevron-up"></i>';
            }
        }
        
        // --- CONNECTION MANAGEMENT ---
        function nextPartner() {
            if (currentMode === 'chat') {
                addSystemMessage('Looking for new partner...');
                setTimeout(() => {
                    simulateChatConnection();
                }, 1500);
            } else if (currentMode === 'video') {
                document.getElementById('videoStatus').style.display = 'block';
                document.getElementById('videoStatus').innerHTML = `
                    <div class="loader mb-4"><span></span><span></span><span></span></div>
                    <p class="text-vibe-yellow font-bold tracking-widest animate-pulse">FINDING NEW PARTNER...</p>
                `;
                setTimeout(() => {
                    simulateVideoConnection();
                }, 2000);
            }
        }
        
        function leaveChat() {
            if (currentPartner) {
                addSystemMessage(`Disconnected from ${currentPartner.name}`);
            }
            showPage('home');
            stopConnection();
        }
        
        function leaveVideoCall() {
            addVideoChatMessage('Call ended', false);
            showPage('home');
            stopConnection();
        }
        
        function leaveGroup() {
            addSystemMessage('Left the group session');
            showPage('home');
            stopConnection();
        }
        
        function stopConnection() {
            isConnected = false;
            currentPartner = null;
            currentRoom = null;
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Clear chat
            if (document.getElementById('chatMessages')) {
                document.getElementById('chatMessages').innerHTML = `
                    <div class="text-center text-vibe-cyan/60 py-8">
                        <i class="fa-solid fa-comment-dots text-4xl mb-3"></i>
                        <p class="text-sm">Disconnected. Return home to start a new connection.</p>
                    </div>
                `;
            }
        }
        
        function cancelConnection() {
            const overlay = document.getElementById('connectingOverlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            showPage('home');
        }
        
        // --- SOCKET.IO HANDLERS ---
        socket.on('connect', () => {
            currentUser.id = socket.id;
            console.log('Connected to server:', socket.id);
        });
        
        socket.on('disconnect', () => {
            addSystemMessage('Disconnected from server. Reconnecting...');
            isConnected = false;
        });
        
        socket.on('matched', (data) => {
            console.log('Matched with:', data);
            currentPartner = data.partner;
            currentRoom = data.room;
            isConnected = true;
            
            // Update UI based on mode
            if (currentMode === 'chat') {
                document.getElementById('partnerName').textContent = currentPartner.name;
                updateInterestTags(currentPartner.interests, 'commonInterests');
                addSystemMessage(`Connected to ${currentPartner.name}`);
            } else if (currentMode === 'video') {
                document.getElementById('videoPartnerName').textContent = currentPartner.name;
                updateInterestTags(currentPartner.interests, 'videoCommonInterests');
                document.getElementById('videoStatus').style.display = 'none';
            }
            
            // Initialize WebRTC
            initializeWebRTC(data.initiator);
        });
        
        socket.on('message', (data) => {
            if (data.room === currentRoom && data.sender !== currentUser.id) {
                if (data.type === 'text') {
                    addMessage(data.content, false);
                } else if (data.type === 'file') {
                    // Handle file transfer
                } else if (data.type === 'typing') {
                    // Show typing indicator
                }
            }
        });
        
        socket.on('partner_left', () => {
            addSystemMessage('Partner disconnected');
            stopConnection();
        });
        
        // --- WEBRTC INITIALIZATION ---
        function initializeWebRTC(isInitiator) {
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(config);
            
            // Add local stream
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Handle incoming streams
            peerConnection.ontrack = (event) => {
                if (event.streams && event.streams[0]) {
                    if (currentMode === 'video' && document.getElementById('remoteVideo')) {
                        document.getElementById('remoteVideo').srcObject = event.streams[0];
                    }
                }
            };
            
            // ICE candidate handling
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice_candidate', {
                        room: currentRoom,
                        candidate: event.candidate
                    });
                }
            };
            
            // Create data channel for chat
            if (isInitiator) {
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }
            
            // Create offer/answer
            if (isInitiator) {
                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        socket.emit('offer', {
                            room: currentRoom,
                            offer: peerConnection.localDescription
                        });
                    });
            }
        }
        
        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log('Data channel opened');
            };
            
            dataChannel.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'message') {
                        addMessage(data.content, false);
                    } else if (data.type === 'file') {
                        // Handle file
                    }
                } catch (e) {
                    addMessage(event.data, false);
                }
            };
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize socket
            socket.connect();
            
            // Set up event listeners
            document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            document.getElementById('videoChatInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendVideoChat();
                }
            });
            
            // Handle back button
            window.addEventListener('popstate', () => {
                showPage('home');
            });
            
            // Initialize scroll button
            window.addEventListener('scroll', () => {
                const scrollBtn = document.getElementById('scrollTopBtn');
                const header = document.getElementById('mainHeader');
                
                if (window.scrollY > 400) {
                    scrollBtn.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-10');
                } else {
                    scrollBtn.classList.add('opacity-0', 'pointer-events-none', 'translate-y-10');
                }
                
                if (window.scrollY > 50) {
                    header.classList.add('opacity-0', 'pointer-events-none');
                } else {
                    header.classList.remove('opacity-0', 'pointer-events-none');
                }
            });
            
            // Close modal on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            console.log('Vibe Konek initialized');
        });
        
        // --- UTILITY FUNCTIONS ---
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
        
        function simulateAudioConnection() {
            // Audio connection would be similar to video but without video tracks
            showPage('video'); // Using same screen but without video
            document.getElementById('videoScreen').querySelector('video').style.display = 'none';
            addSystemMessage('Audio connection established');
        }
        
        function toggleGroupVideo() {
            // Toggle group video
        }
        
        function toggleGroupAudio() {
            // Toggle group audio
        }
        
        function toggleGroupScreenShare() {
            // Toggle group screen share
        }
        
        function toggleGroupChat() {
            // Toggle group chat panel
        }
        
        function inviteToGroup() {
            const inviteCode = generateRoomId().substring(0, 8).toUpperCase();
            addSystemMessage(`Invite code: ${inviteCode}. Share this with friends to join!`);
        }
    </script>
</body>
</html>
